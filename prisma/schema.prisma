generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum SubscriptionPlan {
  FREE
  STANDARD
  PREMIUM
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role     @default(USER)
  purposes      String[] @default([])
  avatarUrl     String?
  language      String   @default("en") // User's preferred language (en, de, es)

  subscription  SubscriptionPlan @default(FREE)
  subscribedAt  DateTime?

  // Token balance and referral
  tokenBalance  Float    @default(0)
  referralCode  String?  @unique // User's personal referral code
  referredBy    String?  // ID of user who referred this user

  // Session/Activity tracking
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?
  lastIpAddress String?
  lastUserAgent String?
  lastCountry   String?
  lastCity      String?
  loginCount    Int      @default(0)

  // Total spending
  totalSpent    Float    @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  persona         Persona?
  memories        Memory[]
  timeCapsules    TimeCapsule[]
  wisdomChats     WisdomChat[]
  sessions        UserSession[]
  purchases       Purchase[]
  generatedVideos GeneratedVideo[]
  familyMembers   FamilyMember[]

  @@map("users")
}

model Persona {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personality traits (0-100)
  humor          Int      @default(50)
  empathy        Int      @default(50)
  tradition      Int      @default(50)
  adventure      Int      @default(50)
  wisdom         Int      @default(50)
  creativity     Int      @default(50)
  patience       Int      @default(50)
  optimism       Int      @default(50)

  // Core values and philosophy
  coreValues     String[] @default([])
  lifePhilosophy String?  @db.Text

  // Avatar settings
  avatarStyle    String   @default("realistic")
  backgroundType String   @default("office")

  echoVibe       String   @default("compassionate")
  legacyScore    Int      @default(0)

  // Avatar wizard completion flag
  avatarSetupComplete Boolean @default(false)

  // ElevenLabs Voice Clone
  elevenlabsVoiceId   String?  // The cloned voice ID from ElevenLabs
  elevenlabsVoiceName String?  // Name of the cloned voice

  // HeyGen Photo Avatar
  heygenAvatarId      String?  // The photo avatar group ID from HeyGen
  heygenAvatarName    String?  // Name of the photo avatar

  // LiveAvatar Custom Interactive Avatar
  liveavatarId        String?  // Custom avatar ID from LiveAvatar
  liveavatarName      String?  // Name of the custom avatar
  liveavatarStatus    String?  // pending, training, ready, failed

  // Simli Custom Face for Real-Time Avatar
  simliFaceId         String?  // Custom face ID from Simli
  simliFaceName       String?  // Name of the custom face

  lifeStories    LifeStory[]
  avatarImages   AvatarImage[]
  voiceSamples   VoiceSample[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("personas")
}

model AvatarImage {
  id        String   @id @default(cuid())
  personaId String
  persona   Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  imageData String   @db.Text
  label     String   @default("")
  isActive  Boolean  @default(false)
  echoVibe  String   @default("compassionate") // Avatar-specific vibe

  createdAt DateTime @default(now())

  @@map("avatar_images")
}

model VoiceSample {
  id        String   @id @default(cuid())
  personaId String
  persona   Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  audioData String   @db.Text  // Base64 encoded audio
  label     String   @default("")
  duration  Int      @default(0) // Duration in seconds
  prompt    String?  @db.Text  // The text/prompt that was read

  createdAt DateTime @default(now())

  @@map("voice_samples")
}

model LifeStory {
  id           String   @id @default(cuid())
  personaId    String
  persona      Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  category     String
  questionId   String?
  chapterId    String?
  chapterTitle String?
  question     String?
  content      String   @db.Text

  createdAt    DateTime @default(now())

  @@map("life_stories")
}

model Memory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String   @db.Text
  history     String?  @db.Text
  imageUrl    String?  @db.Text
  videoUrl    String?  @db.Text
  mediaType   String?  // 'image' or 'video'

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("memories")
}

model TimeCapsule {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title        String
  occasion     String
  recipient    String
  message      String   @db.Text
  deliveryDate DateTime
  status       String   @default("sealed")

  createdAt    DateTime @default(now())

  @@map("time_capsules")
}

model WisdomChat {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      String
  content   String   @db.Text

  createdAt DateTime @default(now())

  @@map("wisdom_chats")
}

model ApiConfig {
  id          String   @id @default(cuid())
  service     String   @unique
  apiKey      String
  isActive    Boolean  @default(true)
  settings    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("api_configs")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?

  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model SupportChat {
  id        String   @id @default(cuid())

  userId    String?
  userEmail String?
  userName  String?

  status    String   @default("open") // open, closed

  userTyping    Boolean  @default(false)
  adminTyping   Boolean  @default(false)
  userTypingAt  DateTime?
  adminTypingAt DateTime?

  userLastRead  DateTime?
  adminLastRead DateTime?

  messages  SupportMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("support_chats")
}

model SupportMessage {
  id        String      @id @default(cuid())
  chatId    String
  chat      SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  sender    String   // user, admin
  content   String   @db.Text
  imageUrl  String?  @db.Text

  createdAt DateTime @default(now())

  @@map("support_messages")
}

model BlacklistedTopic {
  id          String   @id @default(cuid())
  topic       String   @unique
  description String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("blacklisted_topics")
}

model Referral {
  id            String   @id @default(cuid())

  referrerId    String   // User who sent the referral
  refereeId     String?  // User who signed up (null until signup)
  refereeEmail  String?  // Email of invited person

  code          String   @unique // Unique referral code
  status        String   @default("pending") // pending, completed, expired, cancelled

  referrerReward Float   @default(0) // Amount rewarded to referrer
  refereeReward  Float   @default(0) // Amount rewarded to referee

  completedAt   DateTime? // When the referral was completed
  expiresAt     DateTime  // When the referral link expires

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("referrals")
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress   String?
  userAgent   String?
  browser     String?
  os          String?
  device      String?
  country     String?
  city        String?
  region      String?

  loginAt     DateTime @default(now())
  logoutAt    DateTime?
  isActive    Boolean  @default(true)

  @@map("user_sessions")
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // subscription, tokens, addon
  productName String   // e.g., "Premium Monthly", "100 Tokens"
  amount      Float    // Price in USD
  currency    String   @default("USD")

  // Subscription specific
  plan        String?  // FREE, STANDARD, PREMIUM
  period      String?  // monthly, yearly

  // Token specific
  tokenAmount Int?

  // Payment details
  paymentMethod   String?  // stripe, paypal
  paymentId       String?  // External payment reference
  status          String   @default("completed") // pending, completed, failed, refunded

  createdAt   DateTime @default(now())

  @@map("purchases")
}

model ShopProduct {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  price       Float
  currency    String   @default("EUR")
  imageUrl    String?  @db.Text
  category    String   @default("addon") // subscription, tokens, addon
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shop_products")
}

model AvatarBackground {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String   @db.Text
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())

  @@map("avatar_backgrounds")
}

// Generated Videos Archive - stores all avatar videos for users
model GeneratedVideo {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Video metadata
  title       String              // Video title/template name
  text        String   @db.Text   // The text/message that was spoken
  videoId     String   @unique    // HeyGen video ID for status polling
  videoUrl    String?  @db.Text   // Final video URL when completed
  thumbnailUrl String? @db.Text   // Optional thumbnail

  // Status tracking
  status      String   @default("pending") // pending, processing, completed, failed
  error       String?  @db.Text   // Error message if failed
  duration    Int?     // Video duration in seconds (when completed)

  // Provider info
  provider    String   @default("heygen") // heygen, liveavatar, etc.

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("generated_videos")
}

// Family Tree - stores family members for each user
model FamilyMember {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name         String
  relationship String   // Father, Mother, Grandfather, Grandmother, Son, Daughter, etc.
  imageData    String   @db.Text  // Base64 encoded photo

  // Optional details
  birthYear    String?
  birthplace   String?
  bio          String?  @db.Text  // Story, memories, important details
  isDeceased   Boolean  @default(false)
  deathYear    String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@map("family_members")
}
