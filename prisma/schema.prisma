generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum SubscriptionPlan {
  FREE
  STANDARD
  PREMIUM
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role     @default(USER)
  purposes      String[] @default([])
  avatarUrl     String?
  language      String   @default("en") // User's preferred language (en, de, es)

  subscription  SubscriptionPlan @default(FREE)
  subscribedAt  DateTime?

  // Token balance and referral
  tokenBalance  Float    @default(0)
  referralCode  String?  @unique // User's personal referral code
  referredBy    String?  // ID of user who referred this user

  // Contact information for notifications
  phoneNumber      String?
  telegramUsername String?

  // Session/Activity tracking
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?
  lastIpAddress String?
  lastUserAgent String?
  lastCountry   String?
  lastCity      String?
  loginCount    Int      @default(0)

  // Total spending
  totalSpent    Float    @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  persona         Persona?
  memories        Memory[]
  timeCapsules    TimeCapsule[]
  wisdomChats     WisdomChat[]
  sessions        UserSession[]
  purchases       Purchase[]
  generatedVideos GeneratedVideo[]
  familyMembers   FamilyMember[]
  notifications   Notification[]

  @@map("users")
}

model Persona {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personality traits (0-100)
  humor          Int      @default(50)
  empathy        Int      @default(50)
  tradition      Int      @default(50)
  adventure      Int      @default(50)
  wisdom         Int      @default(50)
  creativity     Int      @default(50)
  patience       Int      @default(50)
  optimism       Int      @default(50)

  // Core values and philosophy
  coreValues     String[] @default([])
  lifePhilosophy String?  @db.Text

  // Avatar settings
  avatarStyle    String   @default("realistic")
  backgroundType String   @default("office")

  echoVibe       String   @default("compassionate")
  legacyScore    Int      @default(0)

  // Avatar wizard completion flag
  avatarSetupComplete Boolean @default(false)

  // ElevenLabs Voice Clone
  elevenlabsVoiceId   String?  // The cloned voice ID from ElevenLabs
  elevenlabsVoiceName String?  // Name of the cloned voice

  // HeyGen Photo Avatar
  heygenAvatarId      String?  // The photo avatar group ID from HeyGen
  heygenAvatarName    String?  // Name of the photo avatar

  // LiveAvatar Custom Interactive Avatar
  liveavatarId        String?  // Custom avatar ID from LiveAvatar
  liveavatarName      String?  // Name of the custom avatar
  liveavatarStatus    String?  // pending, training, ready, failed

  // Simli Custom Face for Real-Time Avatar
  simliFaceId         String?  // Custom face ID from Simli
  simliFaceName       String?  // Name of the custom face

  lifeStories    LifeStory[]
  avatarImages   AvatarImage[]
  voiceSamples   VoiceSample[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("personas")
}

model AvatarImage {
  id        String   @id @default(cuid())
  personaId String
  persona   Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  imageData String   @db.Text
  label     String   @default("")
  isActive  Boolean  @default(false)
  echoVibe  String   @default("compassionate") // Avatar-specific vibe

  createdAt DateTime @default(now())

  @@map("avatar_images")
}

model VoiceSample {
  id        String   @id @default(cuid())
  personaId String
  persona   Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  audioData String   @db.Text  // Base64 encoded audio
  label     String   @default("")
  duration  Int      @default(0) // Duration in seconds
  prompt    String?  @db.Text  // The text/prompt that was read

  createdAt DateTime @default(now())

  @@map("voice_samples")
}

model LifeStory {
  id           String   @id @default(cuid())
  personaId    String
  persona      Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  category     String
  questionId   String?
  chapterId    String?
  chapterTitle String?
  question     String?
  content      String   @db.Text

  createdAt    DateTime @default(now())

  @@map("life_stories")
}

model Memory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String   @db.Text
  history     String?  @db.Text
  imageUrl    String?  @db.Text
  videoUrl    String?  @db.Text
  mediaType   String?  // 'image' or 'video'

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("memories")
}

model TimeCapsule {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title        String
  occasion     String
  recipient    String
  message      String   @db.Text
  deliveryDate DateTime
  status       String   @default("sealed")

  createdAt    DateTime @default(now())

  @@map("time_capsules")
}

model WisdomChat {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      String
  content   String   @db.Text

  createdAt DateTime @default(now())

  @@map("wisdom_chats")
}

model ApiConfig {
  id          String   @id @default(cuid())
  service     String   @unique
  apiKey      String
  isActive    Boolean  @default(true)
  settings    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("api_configs")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?

  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model SupportChat {
  id        String   @id @default(cuid())

  userId    String?
  userEmail String?
  userName  String?

  status    String   @default("open") // open, closed

  userTyping    Boolean  @default(false)
  adminTyping   Boolean  @default(false)
  userTypingAt  DateTime?
  adminTypingAt DateTime?

  userLastRead  DateTime?
  adminLastRead DateTime?

  messages  SupportMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("support_chats")
}

model SupportMessage {
  id        String      @id @default(cuid())
  chatId    String
  chat      SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  sender    String   // user, admin
  content   String   @db.Text
  imageUrl  String?  @db.Text

  createdAt DateTime @default(now())

  @@map("support_messages")
}

model BlacklistedTopic {
  id          String   @id @default(cuid())
  topic       String   @unique
  description String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("blacklisted_topics")
}

model Referral {
  id            String   @id @default(cuid())

  referrerId    String   // User who sent the referral
  refereeId     String?  // User who signed up (null until signup)
  refereeEmail  String?  // Email of invited person

  code          String   @unique // Unique referral code
  status        String   @default("pending") // pending, completed, expired, cancelled

  referrerReward Float   @default(0) // Amount rewarded to referrer
  refereeReward  Float   @default(0) // Amount rewarded to referee

  completedAt   DateTime? // When the referral was completed
  expiresAt     DateTime  // When the referral link expires

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("referrals")
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress   String?
  userAgent   String?
  browser     String?
  os          String?
  device      String?
  country     String?
  city        String?
  region      String?

  loginAt     DateTime @default(now())
  logoutAt    DateTime?
  isActive    Boolean  @default(true)

  @@map("user_sessions")
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // subscription, tokens, addon
  productName String   // e.g., "Premium Monthly", "100 Tokens"
  amount      Float    // Price in USD
  currency    String   @default("USD")

  // Subscription specific
  plan        String?  // FREE, STANDARD, PREMIUM
  period      String?  // monthly, yearly

  // Token specific
  tokenAmount Int?

  // Payment details
  paymentMethod   String?  // stripe, paypal
  paymentId       String?  // External payment reference
  status          String   @default("completed") // pending, completed, failed, refunded

  createdAt   DateTime @default(now())

  @@map("purchases")
}

model ShopProduct {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  price       Float
  currency    String   @default("EUR")
  imageUrl    String?  @db.Text
  category    String   @default("addon") // subscription, tokens, addon
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shop_products")
}

model AvatarBackground {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String   @db.Text
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())

  @@map("avatar_backgrounds")
}

// Generated Videos Archive - stores all avatar videos for users
model GeneratedVideo {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Video metadata
  title       String              // Video title/template name
  text        String   @db.Text   // The text/message that was spoken
  videoId     String   @unique    // HeyGen video ID for status polling
  videoUrl    String?  @db.Text   // Final video URL when completed
  thumbnailUrl String? @db.Text   // Optional thumbnail

  // Status tracking
  status      String   @default("pending") // pending, processing, completed, failed
  error       String?  @db.Text   // Error message if failed
  duration    Int?     // Video duration in seconds (when completed)

  // Provider info
  provider    String   @default("heygen") // heygen, liveavatar, etc.

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("generated_videos")
}

// Family Tree - stores family members for each user
model FamilyMember {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name         String
  relationship String   // Father, Mother, Grandfather, Grandmother, Son, Daughter, etc.
  imageData    String?  @db.Text  // Base64 encoded photo (optional)
  voiceData    String?  @db.Text  // Base64 encoded audio (optional)

  // Optional details
  birthYear    String?
  birthplace   String?
  bio          String?  @db.Text  // Story, memories, important details
  isDeceased   Boolean  @default(false)
  deathYear    String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@map("family_members")
}

// Notifications - system and admin notifications for users
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  title     String
  message   String   @db.Text
  type      String   @default("info") // info, success, warning, error, announcement
  category  String?  // legacy, mission, system, admin, etc.

  // Link/Action
  link      String?  // Optional link to redirect user (e.g., /persona, /echo-sim)
  actionText String? // Text for action button (e.g., "Complete Now", "View")

  // Status
  isRead    Boolean  @default(false)
  readAt    DateTime?

  // Sender info (for admin-sent notifications)
  senderId  String?  // Admin user ID who sent this
  senderName String? // Admin name for display

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// Echo Timeline - Interactive life journey with events
model TimelineEvent {
  id          String   @id @default(cuid())
  userId      String
  personaId   String?  // Optional: link to specific persona/avatar

  // Event details
  title       String
  description String?  @db.Text
  eventDate   DateTime // When this event happened in real life
  ageAtEvent  Int?     // How old user was at this event

  // Event categorization
  category    String   // childhood, education, career, family, milestone, achievement, etc.
  importance  Int      @default(3) // 1-5 stars

  // Media attachments
  imageUrl    String?  @db.Text
  videoUrl    String?  @db.Text
  audioNote   String?  @db.Text // Audio message from avatar about this event

  // Avatar message for this event
  avatarMessage String? @db.Text // What the avatar says about this event

  // Position in timeline
  sortOrder   Int      @default(0)

  // Visibility
  isPublic    Boolean  @default(false) // Share with family?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([eventDate])
  @@map("timeline_events")
}

// Echo Duet - User videos with avatar responses
model EchoDuet {
  id              String   @id @default(cuid())
  userId          String

  // User's video
  userVideoUrl    String   @db.Text // URL to user's uploaded video
  userTranscript  String?  @db.Text // What user said (from speech-to-text)
  userQuestion    String?  @db.Text // Extracted question/topic

  // Avatar's response
  avatarVideoUrl  String?  @db.Text // Generated avatar response video
  avatarResponse  String?  @db.Text // What avatar said
  avatarEmotion   String?  @default("thoughtful") // compassionate, proud, nostalgic, etc.

  // Metadata
  title           String?  // Optional title for this duet
  topic           String?  // conversation, advice, memory, celebration, etc.
  duration        Int?     // Total duration in seconds

  // Status
  status          String   @default("processing") // processing, completed, failed
  processingError String?  @db.Text

  // Engagement
  viewCount       Int      @default(0)
  isFavorite      Boolean  @default(false)
  isPublic        Boolean  @default(false) // Share with family?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("echo_duets")
}

// Wisdom Cards - Daily inspiration messages
model WisdomCard {
  id              String   @id @default(cuid())
  userId          String

  // Card content
  title           String
  message         String   @db.Text
  quote           String?  @db.Text // Optional quote
  wisdom          String?  @db.Text // Additional wisdom/advice

  // Appearance
  cardStyle       String   @default("default") // default, vintage, modern, minimalist
  imageUrl        String?  @db.Text // Background image
  accentColor     String   @default("gold") // gold, blue, purple, green

  // Timing & delivery
  scheduledFor    DateTime? // When to show this card (future scheduling)
  shownAt         DateTime? // When user actually viewed it

  // Categorization
  category        String?  // inspiration, advice, memory, celebration, reflection
  tags            String[] @default([])

  // Triggers (when to show this card)
  triggerEvent    String?  // birthday, anniversary, achievement, tough_time, etc.
  triggerDate     DateTime? // Specific date to trigger

  // Status
  isRead          Boolean  @default(false)
  isFavorite      Boolean  @default(false)

  // Audio
  audioUrl        String?  @db.Text // Avatar reading this card

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([scheduledFor])
  @@index([isRead])
  @@map("wisdom_cards")
}

// Echo Games - Gamification system
model GameProgress {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Overall stats
  totalPoints     Int      @default(0)
  level           Int      @default(1)
  currentStreak   Int      @default(0) // Days in a row
  longestStreak   Int      @default(0)

  // Achievements unlocked
  achievements    String[] @default([]) // Array of achievement IDs

  // Game-specific progress
  twentyQuestionsPlayed     Int @default(0)
  twentyQuestionsWon        Int @default(0)
  treasureHuntsCompleted    Int @default(0)
  guessTheYearCorrect       Int @default(0)
  guessTheYearPlayed        Int @default(0)

  // Rewards
  cardsCollected  Int      @default(0) // Collectible story cards
  badgesEarned    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("game_progress")
}

model GameSession {
  id              String   @id @default(cuid())
  userId          String

  // Game details
  gameType        String   // twenty_questions, treasure_hunt, guess_year, story_match
  difficulty      String   @default("medium") // easy, medium, hard

  // Session data
  questionsAsked  Int      @default(0)
  correctAnswers  Int      @default(0)
  hintsUsed       Int      @default(0)
  timeSpent       Int?     // Seconds

  // Results
  completed       Boolean  @default(false)
  won             Boolean  @default(false)
  pointsEarned    Int      @default(0)

  // Game-specific data (JSON)
  gameData        String?  @db.Text // Flexible JSON storage

  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([gameType])
  @@map("game_sessions")
}

model Achievement {
  id              String   @id @default(cuid())

  // Achievement details
  key             String   @unique // story_collector_10, time_traveler, perfect_streak_7
  name            String
  description     String   @db.Text
  icon            String   // Icon name or emoji
  rarity          String   @default("common") // common, rare, epic, legendary

  // Unlock requirements
  requirementType String   // points, streak, games_won, cards_collected, etc.
  requirementValue Int     // Threshold to unlock

  // Rewards
  pointsReward    Int      @default(0)
  badgeUrl        String?  @db.Text

  createdAt       DateTime @default(now())

  @@map("achievements")
}
